<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¤å»³æ¡Œä½ç®¡ç†</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-database-compat.js"></script>
    <style>
        h1 {
            font-size: 0px; /* èª¿æ•´ h1 çš„å­—é«”å¤§å° */
        }
        h2 {
            font-size: 0px; /* èª¿æ•´ h2 çš„å­—é«”å¤§å° */
        }
        h3 {
            font-size: 0px; /* èª¿æ•´ h3 çš„å­—é«”å¤§å° */
        }
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }
        .table-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 0px;
        }
        .table {
            width: 90px;
            height: 90px;
            margin: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            position: relative;
            padding: 5px;
        }
        .reservation-id {
            position: absolute;
            top: 5px;
            left: 5px;
            font-size: 12px;
            color: #825400;
        }
        .reservation-id-secondary {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 12px;
            color: #825400;
            opacity: 0.6;
        }
        .empty { background-color: #ccc; }
        .reserved { background-color: #EFB700; }
        .occupied { background-color: #04AA6D; color: black; }
        .finished { background-color: #d9534f; color: white; }
        .finished::after { content: "æ”¶æ¡Œä¸­"; font-size: 14px; }

        .input-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }
        input, button, select {
            padding: 10px;
            font-size: 14px;
        }
        .row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .name-buttons {
            display: flex;
            gap: 5px;
            margin: 0; /* ç§»é™¤ margin-topï¼Œè®“å®ƒå’Œè¼¸å…¥æ¡†åŒä¸€è¡Œ */
        }

        .name-buttons button {
            padding: 5px 10px;
            background-color: #ddd;
            border: none;
            cursor: pointer;
            border-radius: 2px;
        }

        .name-buttons button.active {
            background-color: #000000;
            color: white;
        }

        .waitlist-item {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 10px;
            width: 100%;
            max-width: 500px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #F7F7F7;
            text-align: center;
            box-sizing: border-box;
        }
        .button-container {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
        }
        .table-button {
            padding: 5px 10px;
            background-color: #04AA6D;
            color: white;
            border: none;
            cursor: pointer;
            
            border-radius: 2px;
        }
        .confirm-button {
            padding: 5px 10px;
            background-color: #000000;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 2px;
        }
        .cancel-button {
            padding: 5px 10px;
            background-color: #d9534f;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 2px;
        }
        .time-info {
            font-size: 14px;
            margin-top: 5px;
        }
        .before-time {
            color: #4286BD;
        }
        .after-time {
            color: #e51f1a;
        }
        ul {
            list-style: none;
            padding: 0;
            margin: 0;
            width: 100%;
        }
        /* çˆ¶ç´šå®¹å™¨æ¨£å¼ */
        .waitlist-container {
            display: flex;
            justify-content: center;
            align-items: center;     /* å‚ç›´ç½®ä¸­ */
            width: 100%;            /* ä½”æ»¿çˆ¶å…ƒç´ å¯¬åº¦ */
            margin: 10px 0;         /* ä¸Šä¸‹ç•™ä¸€äº›é–“è· */
        }

        /* æ–°å¢çš„ Tab æ ·å¼ */
        .tabs {
            display: flex;
            justify-content: center;
            margin: 20px 0px;
            width: 100%;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }
        .tab-button {
            flex: 1;
            padding: 6px;
            cursor: pointer;
            border: 1px solid #ccc;
            background-color: #f8f8f8;
            font-size: 18px;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .tab-button.active {
            background-color: #000000;
            color: white;
            border-color: #000000;
        }
        .tab-button:first-child {
            border-radius: 8px 0 0 8px;
        }
        .tab-button:last-child {
            border-radius: 0 8px 8px 0;
        }
        .tab-content {
            display: none;
            width: 100%;
        }
        .tab-content.active {
            display: block;
            
        }
        .table-button:disabled {
            background-color: #cccccc !important;
            cursor: not-allowed !important;
            opacity: 0.6;
        }
        /* æ·»åŠ åŒæ­¥æç¤ºçš„æ¨£å¼ */
        .sync-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
            transition: opacity 0.3s;
        }
        .syncing {
            background-color: #ffc107;
            color: #000;
        }
        .synced {
            background-color: #28a745;
            color: #fff;
        }
        .sync-error {
            background-color: #dc3545;
            color: #fff;
        }
        /* åƒåœ¾æ¡¶æŒ‰éˆ•æ¨£å¼ */
        .clear-data-button {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            background-color: #ff4444; /* ç´…è‰²èƒŒæ™¯ */
            border: 2px solid white; /* ç™½ç·šæ¢ */
            border-radius: 50%; /* åœ“å½¢ */
            color: white;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); /* é™°å½±æ•ˆæœ */
            transition: background-color 0.3s ease;
        }

        .clear-data-button:hover {
            background-color: #cc0000; /* é¼ æ¨™æ‡¸åœæ™‚è®Šæ·±ç´…è‰² */
        }

        .clear-data-button:active {
            background-color: #990000; /* æŒ‰éˆ•æŒ‰ä¸‹æ™‚è®Šæ›´æ·±çš„ç´…è‰² */
        }
    </style>
</head>
<body>
    <!-- æ¸…é™¤è³‡æ–™æŒ‰éˆ• -->
    <div class="clear-data-button" onclick="clearFirebaseData()">
        ğŸ—‘ï¸ <!-- åƒåœ¾æ¡¶åœ–æ¨™ -->
    
    <h1>é¤å»³æ¡Œä½ç®¡ç†</h1>
    <!-- åŒæ­¥ç‹€æ…‹æç¤º -->
    <div id="syncStatus" class="sync-status" style="display: none;"></div>
    <div class="table-container" id="tables"></div>

    <!-- Tab åˆ‡æ›æŒ‰éˆ• -->
    <div class="tabs">
        <div class="tab-button active" onclick="openTab('reservedTab')">è¨‚ä½</div>
        <div class="tab-button" onclick="openTab('waitingTab')">å€™ä½</div>
    </div>

    <!-- è¨‚ä½ Tab å…§å®¹ -->
    <div id="reservedTab" class="tab-content active">
        <h2>å·²è¨‚ä½</h2>
        <ul id="reservedList"></ul>
        <div class="input-container">
            <div class="row">
                <input type="number" id="reservedCount" placeholder="äººæ•¸" min="1">
            </div>
            <div class="row">
                <input type="text" id="reservedName" placeholder="å§“æ°" style="width: 82px;">
                <div class="name-buttons">
                     <button id="mrButtonReserved" onclick="selectTitleReserved('å…ˆç”Ÿ')">å…ˆç”Ÿ</button>
                     <button id="msButtonReserved" onclick="selectTitleReserved('å°å§')">å°å§</button>
                </div>
            </div>
            
            <input type="tel" id="reservedPhone" placeholder="æ‰‹æ©Ÿ">
            <select id="reservedTime">
                <option value="11:00">11:00</option>
                <option value="11:30">11:30</option>
                <option value="12:00">12:00</option>
                <option value="12:30">12:30</option>
                <option value="13:00">13:00</option>
                <option value="17:00">17:00</option>
                <option value="17:30">17:30</option>
                <option value="18:00">18:00</option>
                <option value="18:30">18:30</option>
                <option value="19:00">19:00</option>
                <option value="19:30">19:30</option>
                <option value="20:00">20:00</option>
            </select>
            <button onclick="addToReservedList()">æ–°å¢è¨‚ä½</button>
        </div>
        
    </div>

    <!-- å€™ä½ Tab å…§å®¹ -->
    <div id="waitingTab" class="tab-content">
        <h3>å·²å€™ä½</h3>
        <ul id="waitingList"></ul>
        <div class="input-container">
            <div class="row">
                <input type="number" id="waitingCount" placeholder="äººæ•¸" min="1">
            </div>
            <div class="row">
                <input type="text" id="waitingName" placeholder="å§“æ°" style="width: 82px;">
                <div class="name-buttons">
                     <button id="mrButtonWaiting" onclick="selectTitleWaiting('å…ˆç”Ÿ')">å…ˆç”Ÿ</button>
                     <button id="msButtonWaiting" onclick="selectTitleWaiting('å°å§')">å°å§</button>
                </div>
            </div>
            
            <input type="tel" id="waitingPhone" placeholder="æ‰‹æ©Ÿ">
            <button onclick="addToWaitingList()">æ–°å¢å€™ä½</button>
        </div>
        
    </div>

    <script>
        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyCp8_-QPKaR6Q6ECK9np3OPqW6dO967wpk",
            authDomain: "reserve-a3e41.firebaseapp.com",
            databaseURL: "https://reserve-a3e41-default-rtdb.firebaseio.com",
            projectId: "reserve-a3e41",
            storageBucket: "reserve-a3e41.firebasestorage.app",
            messagingSenderId: "25864343238",
            appId: "1:25864343238:web:7d31cb753ae557b49391c7",
            measurementId: "G-EX5CQE079X"
        };
        
        // åˆå§‹åŒ– Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // åŒæ­¥ç‹€æ…‹é¡¯ç¤ºå‡½æ•¸
        function showSyncStatus(status, message) {
            const syncStatus = document.getElementById('syncStatus');
            syncStatus.textContent = message;
            syncStatus.className = 'sync-status ' + status;
            syncStatus.style.display = 'block';
            
            // 3ç§’å¾Œéš±è—æç¤ºï¼ˆé™¤éæ˜¯åŒæ­¥ä¸­ç‹€æ…‹ï¼‰
            if (status !== 'syncing') {
                setTimeout(() => {
                    syncStatus.style.opacity = '0';
                    setTimeout(() => {
                        syncStatus.style.display = 'none';
                        syncStatus.style.opacity = '1';
                    }, 300);
                }, 3000);
            }
        }
        
        const tables = [1, 2, 4, 5, 6, 7, 8, 10];
        let tableStatus = {};
        let reservedList = [];
        let waitingList = [];
        let reservationCounter = 1;
        let waitingCounter = 1;
        let selectedTitleReserved = "å…ˆç”Ÿ";
        let selectedTitleWaiting = "å…ˆç”Ÿ";
        let dataChanged = false; // ç”¨æ–¼è¿½è¸ªæ•¸æ“šæ˜¯å¦æœ‰è®ŠåŒ–
        let isSyncing = false; // é¿å…åŒæ­¥è¡çª

        // Firebase æ•¸æ“šè®ŠåŒ–ç›£è½
        function setupFirebaseListeners() {
            // ç›£è½æ¡Œä½ç‹€æ…‹è®ŠåŒ–
            database.ref('tableStatus').on('value', (snapshot) => {
                if (!isSyncing) {
                    const data = snapshot.val();
                    if (data) {
                        // è½‰æ›Firebaseæ•¸æ“šæ ¼å¼ï¼ˆè™•ç†timestampï¼‰
                        tableStatus = {};
                        Object.keys(data).forEach(table => {
                            tableStatus[table] = convertFromFirebase(data[table]);
                        });
                        renderTables();
                        showSyncStatus('synced', 'å·²åŒæ­¥æ¡Œä½ç‹€æ…‹');
                    }
                }
            }, (error) => {
                console.error("æ¡Œä½ç‹€æ…‹è®€å–éŒ¯èª¤:", error);
                showSyncStatus('sync-error', 'åŒæ­¥éŒ¯èª¤ï¼šæ¡Œä½ç‹€æ…‹');
            });
            
            // ç›£è½è¨‚ä½åˆ—è¡¨è®ŠåŒ–
            database.ref('reservedList').on('value', (snapshot) => {
                if (!isSyncing) {
                    const data = snapshot.val();
                    if (data) {
                        reservedList = Object.values(data);
                        // æ‰¾å‡ºæœ€å¤§IDä»¥ä¾¿ç¹¼çºŒè¨ˆæ•¸
                        const maxId = Math.max(...reservedList.map(item => item.id), 0);
                        reservationCounter = maxId + 1;
                        renderReservedList();
                        showSyncStatus('synced', 'å·²åŒæ­¥è¨‚ä½è³‡æ–™');
                    }
                }
            }, (error) => {
                console.error("è¨‚ä½åˆ—è¡¨è®€å–éŒ¯èª¤:", error);
                showSyncStatus('sync-error', 'åŒæ­¥éŒ¯èª¤ï¼šè¨‚ä½è³‡æ–™');
            });
            
            // ç›£è½å€™ä½åˆ—è¡¨è®ŠåŒ–
            database.ref('waitingList').on('value', (snapshot) => {
                if (!isSyncing) {
                    const data = snapshot.val();
                    if (data) {
                        waitingList = Object.values(data);
                        // æ‰¾å‡ºæœ€å¤§IDä»¥ä¾¿ç¹¼çºŒè¨ˆæ•¸
                        const maxId = Math.max(...waitingList.map(item => item.id), 0);
                        waitingCounter = maxId + 1;
                        renderWaitingList();
                        showSyncStatus('synced', 'å·²åŒæ­¥å€™ä½è³‡æ–™');
                    }
                }
            }, (error) => {
                console.error("å€™ä½åˆ—è¡¨è®€å–éŒ¯èª¤:", error);
                showSyncStatus('sync-error', 'åŒæ­¥éŒ¯èª¤ï¼šå€™ä½è³‡æ–™');
            });
        }
        
        // å°‡å°è±¡è½‰æ›ç‚ºFirebaseå¯å­˜å„²çš„æ ¼å¼ï¼ˆè™•ç†Dateå°è±¡ï¼‰
        function convertToFirebase(obj) {
            if (!obj) return obj;
            
            const result = {};
            Object.keys(obj).forEach(key => {
                if (obj[key] instanceof Date) {
                    // å°‡Dateè½‰æ›ç‚ºtimestamp
                    result[key] = {
                        __isDate: true,
                        timestamp: obj[key].getTime()
                    };
                } else if (typeof obj[key] === 'object' && obj[key] !== null) {
                    result[key] = convertToFirebase(obj[key]);
                } else {
                    result[key] = obj[key];
                }
            });
            return result;
        }
        
        // å°‡Firebaseæ•¸æ“šè½‰æ›å›åŸå§‹æ ¼å¼
        function convertFromFirebase(obj) {
            if (!obj) return obj;
            
            const result = {};
            Object.keys(obj).forEach(key => {
                if (obj[key] && obj[key].__isDate && obj[key].timestamp) {
                    // å°‡timestampè½‰å›Dateå°è±¡
                    result[key] = new Date(obj[key].timestamp);
                } else if (typeof obj[key] === 'object' && obj[key] !== null) {
                    result[key] = convertFromFirebase(obj[key]);
                } else {
                    result[key] = obj[key];
                }
            });
            return result;
        }
        
        // åŒæ­¥æ•¸æ“šåˆ°Firebase
        function syncToFirebase() {
            if (isSyncing) return;
            
            isSyncing = true;
            showSyncStatus('syncing', 'è³‡æ–™åŒæ­¥ä¸­...');
            
            // è½‰æ›æ•¸æ“šæ ¼å¼
            const fbTableStatus = {};
            Object.keys(tableStatus).forEach(table => {
                fbTableStatus[table] = convertToFirebase(tableStatus[table]);
            });
            
            // å‰µå»ºä¸€å€‹æ‰¹é‡æ›´æ–°å°è±¡
            const updates = {};
            updates['tableStatus'] = fbTableStatus;
            updates['reservedList'] = reservedList.reduce((acc, item, index) => {
                acc[index] = item;
                return acc;
            }, {});
            updates['waitingList'] = waitingList.reduce((acc, item, index) => {
                acc[index] = item;
                return acc;
            }, {});
            
            // æ‰¹é‡æ›´æ–°Firebase
            database.ref().update(updates)
                .then(() => {
                    isSyncing = false;
                    showSyncStatus('synced', 'è³‡æ–™å·²åŒæ­¥');
                })
                .catch(error => {
                    console.error("FirebaseåŒæ­¥éŒ¯èª¤:", error);
                    isSyncing = false;
                    showSyncStatus('sync-error', 'åŒæ­¥å¤±æ•—ï¼š' + error.message);
                });
        }

        

        // è¨­ç½®æ•¸æ“šè®ŠåŒ–æ¨™è¨˜çš„å‡½æ•¸
        function markDataChanged() {
            dataChanged = true;
            // æ•¸æ“šæœ‰è®ŠåŒ–æ™‚åŒæ­¥åˆ°Firebase
            syncToFirebase();
        }

        // Tab åˆ‡æ›åŠŸèƒ½
        function openTab(tabName) {
            const tabContents = document.getElementsByClassName("tab-content");
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove("active");
            }

            const tabButtons = document.getElementsByClassName("tab-button");
            for (let i = 0; i < tabButtons.length; i++) {
                tabButtons[i].classList.remove("active");
            }

            document.getElementById(tabName).classList.add("active");
            
            // æ‰¾åˆ°ç›¸æ‡‰çš„æŒ‰éˆ•ä¸¦æ¿€æ´»å®ƒ
            const buttons = document.getElementsByClassName("tab-button");
            for (let i = 0; i < buttons.length; i++) {
                if (buttons[i].getAttribute("onclick").includes(tabName)) {
                    buttons[i].classList.add("active");
                }
            }
        }

        function renderTables() {
            const container = document.getElementById("tables");
            container.innerHTML = "";

            tables.forEach(table => {
                const status = tableStatus[table]?.status || "empty";
                const tableDiv = document.createElement("div");
                tableDiv.className = `table ${status}`;
                
                // ä¸»è¦è¨‚ä½ID
                if (tableStatus[table]?.reservationId) {
                    const reservationId = document.createElement("div");
                    reservationId.className = "reservation-id";
                    reservationId.textContent = `è¨‚${tableStatus[table].reservationId}`;
                    tableDiv.appendChild(reservationId);
                }
                
                // æ¬¡è¦è¨‚ä½ID
                if (tableStatus[table]?.secondaryReservationId) {
                    const secondaryReservationId = document.createElement("div");
                    secondaryReservationId.className = "reservation-id-secondary";
                    secondaryReservationId.textContent = `è¨‚${tableStatus[table].secondaryReservationId}`;
                    tableDiv.appendChild(secondaryReservationId);
                }

                const tableNumber = document.createElement("div");
                tableNumber.textContent = `A${table}`;
                tableDiv.appendChild(tableNumber);

                // å¦‚æœæ˜¯å·²å…¥åº§ç‹€æ…‹
                if (status === "occupied" && tableStatus[table].startTime) {
                    const startTime = tableStatus[table].startTime;
                    const endTime = new Date(startTime.getTime() + 90 * 60000);
                    const timeInfo = document.createElement("div");
                    timeInfo.className = "time-info";
                    timeInfo.innerHTML = 
                        `<div style="color: #005435;">${formatTime(startTime)} å…¥åº§<br>
                        <div style="color: #FFFFFF;">${formatTime(endTime)} çµæŸ`
                    ;
                    tableDiv.appendChild(timeInfo);
                }

                // å¦‚æœæ˜¯è¨‚ä½ç‹€æ…‹ï¼Œé¡¯ç¤ºç•¶å‰æ´»å‹•çš„é è¨‚ä¿¡æ¯
                if (status === "reserved" && tableStatus[table]?.reservedTime) {
                    const timeInfo = document.createElement("div");
                    timeInfo.className = "time-info";
                    
                    const reservedTime = tableStatus[table].reservedTime;
                    const beforeTime = getTimeBeforeReservation(reservedTime);
                    const afterTime = getTimeAfterReservation(reservedTime);
                    
                    timeInfo.innerHTML = 
                        `<div class="before-time">${beforeTime} å‰å¯æ¥</div>
                        <div>${reservedTime}</div>
                        <div class="after-time">${afterTime} å¾Œå¯æ¥</div>`
                    ;
                    tableDiv.appendChild(timeInfo);
                }

                // ä¿®æ”¹é»æ“Šäº‹ä»¶è™•ç†é‚è¼¯
                tableDiv.onclick = () => toggleTable(table);
                container.appendChild(tableDiv);
            });
        }

        function toggleTable(table) {
            const tableState = tableStatus[table];
            
            // If empty table, set to occupied
            if (!tableState || tableState.status === "empty") {
                tableStatus[table] = { 
                    status: "occupied", 
                    startTime: new Date() 
                };
                markDataChanged();
                renderTables();
                return;
            }
            
            // If table has a reservation and no secondary reservation, do nothing
            if (tableState?.status === "reserved" && !tableState?.secondaryReservationId) {
                return;
            }
            
            // If table has both primary and secondary reservations, swap them
            if (tableState?.status === "reserved" && tableState?.secondaryReservationId) {
                const tempId = tableState.reservationId;
                const tempTime = tableState.reservedTime;
                
                tableStatus[table].reservationId = tableState.secondaryReservationId;
                tableStatus[table].reservedTime = tableState.secondaryReservedTime;
                
                tableStatus[table].secondaryReservationId = tempId;
                tableStatus[table].secondaryReservedTime = tempTime;
                
                markDataChanged();
                renderTables();
                return;
            }
            
            // If table is occupied and has a secondary reservation
            if (tableState?.status === "occupied" && tableState?.secondaryReservationId) {
                tableStatus[table] = { 
                    status: "finished", 
                    secondaryReservationId: tableState.secondaryReservationId,
                    secondaryReservedTime: tableState.secondaryReservedTime
                };
                markDataChanged();
                renderTables();
                return;
            }
            
            // If table is in "finished" state and has a secondary reservation
            if (tableState?.status === "finished" && tableState?.secondaryReservationId) {
                tableStatus[table] = { 
                    status: "reserved", 
                    reservationId: tableState.secondaryReservationId,
                    reservedTime: tableState.secondaryReservedTime,
                    secondaryReservationId: null,
                    secondaryReservedTime: null
                };
                markDataChanged();
                renderTables();
                return;
            }
            
            // Standard state transitions for tables without secondary reservations
            if (tableState.status === "occupied") {
                tableStatus[table] = { status: "finished" };
            } else if (tableState.status === "finished") {
                tableStatus[table] = { status: "empty" };
            }
            
            markDataChanged();
            renderTables();
            renderReservedList();
            renderWaitingList();
        }

        function formatTime(date) {
            return date.toLocaleTimeString("zh-TW", { 
                hour: "2-digit", 
                minute: "2-digit", 
                hour12: false 
            });
        }

        function getTimeBeforeReservation(time) {
            const [hours, minutes] = time.split(':').map(Number);
            const date = new Date();
            date.setHours(hours);
            date.setMinutes(minutes - 90);
            return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        }

        function getTimeAfterReservation(time) {
            const [hours, minutes] = time.split(':').map(Number);
            const date = new Date();
            date.setHours(hours);
            date.setMinutes(minutes + 90);
            return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        }

        // æª¢æŸ¥å…©å€‹é è¨‚æ™‚é–“æ˜¯å¦å¯ä»¥å…±å­˜
        function canDoubleBook(time1, time2) {
            const [hours1, minutes1] = time1.split(':').map(Number);
            const [hours2, minutes2] = time2.split(':').map(Number);
            
            // è¨ˆç®—å…©å€‹æ™‚é–“é»ä¹‹é–“çš„åˆ†é˜å·®
            const time1Minutes = hours1 * 60 + minutes1;
            const time2Minutes = hours2 * 60 + minutes2;
            
            // è¨ˆç®—æ™‚é–“å·®çš„çµ•å°å€¼
            const timeDiff = Math.abs(time1Minutes - time2Minutes);
            
            // å¦‚æœæ™‚é–“å·®å¤§æ–¼ç­‰æ–¼90åˆ†é˜ï¼Œå‰‡å…è¨±é›™é‡é è¨‚
            return timeDiff >= 90;
        }

        function selectTitleReserved(title) {
            selectedTitleReserved = title;
            document.getElementById("mrButtonReserved").classList.toggle("active", title === "å…ˆç”Ÿ");
            document.getElementById("msButtonReserved").classList.toggle("active", title === "å°å§");
        }

        function selectTitleWaiting(title) {
            selectedTitleWaiting = title;
            document.getElementById("mrButtonWaiting").classList.toggle("active", title === "å…ˆç”Ÿ");
            document.getElementById("msButtonWaiting").classList.toggle("active", title === "å°å§");
        }

        function addToReservedList() {
            const count = document.getElementById("reservedCount").value;
            const name = document.getElementById("reservedName").value;
            const phone = document.getElementById("reservedPhone").value;
            const reservedTime = document.getElementById("reservedTime").value;
            
            if (!count || !name || !phone || !reservedTime) return;
            
            const reservation = {
                id: reservationCounter++,
                count,
                name,
                title: selectedTitleReserved,
                phone,
                reservedTime,
                assignedTable: null
            };
            
            reservedList.push(reservation);
            markDataChanged();
            clearReservedInputs();
            renderReservedList();
        }

        function addToWaitingList() {
            const count = document.getElementById("waitingCount").value;
            const name = document.getElementById("waitingName").value;
            const phone = document.getElementById("waitingPhone").value;
            
            if (!count || !name || !phone) return;
            
            const waiting = {
                id: waitingCounter++,
                count,
                name,
                title: selectedTitleWaiting,
                phone,
                assignedTable: null
            };
            
            waitingList.push(waiting);
            markDataChanged();
            clearWaitingInputs();
            renderWaitingList();
        }

        // ä¿®æ”¹æ¸²æŸ“é è¨‚åˆ—è¡¨çš„å‡½æ•¸ï¼Œå¢åŠ æ¡Œå­æŒ‰éˆ•ç¦ç”¨é‚è¼¯
function renderReservedList() {
    const list = document.getElementById("reservedList");
    list.innerHTML = "";
    
    reservedList.forEach((guest, index) => {
        // å‰µå»ºçˆ¶å®¹å™¨
        const container = document.createElement("div");
        container.className = "waitlist-container";
        
        const li = document.createElement("li");
        li.className = "waitlist-item";
        li.innerHTML = `è¨‚${guest.id} - ${guest.count}ä½ - ${guest.title} ${guest.name} - ${guest.phone} - è¨‚ä½æ™‚é–“ ${guest.reservedTime}`;
        
        const buttonContainer = document.createElement("div");
        buttonContainer.className = "button-container";

        if (!guest.assignedTable) {
            tables.forEach(table => {
                const button = document.createElement("button");
                button.className = "table-button";
                button.textContent = `A${table}`;
                
                // æª¢æŸ¥è©²æ¡Œæ˜¯å¦æœ‰è¡çªçš„é è¨‚æ™‚é–“
                const isConflict = checkTimeConflict(table, guest.reservedTime);
                
                if (isConflict) {
                    // å¦‚æœæ™‚é–“è¡çªï¼Œç¦ç”¨æŒ‰éˆ•
                    button.disabled = true;
                    button.style.backgroundColor = "#cccccc";
                    button.style.cursor = "not-allowed";
                    button.title = "æ­¤æ¡Œå·²æœ‰æ™‚é–“ç›¸è¿‘çš„é è¨‚";
                } else {
                    button.onclick = () => assignTable(guest.id, table, guest.reservedTime, index);
                }
                
                buttonContainer.appendChild(button);
            });
        } else {
            const confirmButton = document.createElement("button");
            confirmButton.className = "confirm-button";
            confirmButton.textContent = `ç¢ºèªå…¥åº§ A${guest.assignedTable}`;
            confirmButton.onclick = () => confirmSeating(guest.assignedTable, index);
            buttonContainer.appendChild(confirmButton);
        }

        const cancelButton = document.createElement("button");
        cancelButton.className = "cancel-button";
        cancelButton.textContent = "å–æ¶ˆè¨‚ä½";
        cancelButton.onclick = () => cancelReservedOrder(index);
        buttonContainer.appendChild(cancelButton);

        li.appendChild(buttonContainer);
        container.appendChild(li); // å°‡ li æ”¾å…¥çˆ¶ç´šå®¹å™¨ä¸­
        list.appendChild(container);
    });
}

        function renderWaitingList() {
    const list = document.getElementById("waitingList");
    list.innerHTML = "";
    
    waitingList.forEach((guest, index) => {
        const container = document.createElement("div");
        container.className = "waitlist-container";

        const li = document.createElement("li");
        li.className = "waitlist-item";
        li.innerHTML = `å€™${guest.id} - ${guest.count}ä½ - ${guest.title} ${guest.name} - ${guest.phone}`;
        
        const buttonContainer = document.createElement("div");
        buttonContainer.className = "button-container";

        if (!guest.assignedTable) {
            tables.forEach(table => {
                const button = document.createElement("button");
                button.className = "table-button";
                button.textContent = `A${table}`;
                
                button.onclick = () => assignWaitingTable(table, index);
                buttonContainer.appendChild(button);
            });
        } else {
            li.innerHTML += ` - A${guest.assignedTable}`;
            const confirmButton = document.createElement("button");
            confirmButton.className = "confirm-button";
            confirmButton.textContent = "ç¢ºèªå…¥åº§";
            confirmButton.onclick = () => confirmWaitingSeating(guest.assignedTable, index);
            buttonContainer.appendChild(confirmButton);
        }

        const cancelButton = document.createElement("button");
        cancelButton.className = "cancel-button";
        cancelButton.textContent = "å–æ¶ˆå€™ä½";
        cancelButton.onclick = () => cancelWaitingOrder(index);
        buttonContainer.appendChild(cancelButton);

        li.appendChild(buttonContainer);
        container.appendChild(li);
        list.appendChild(container);
    });
}
// æ–°å¢å‡½æ•¸ï¼šæª¢æŸ¥æ˜¯å¦å­˜åœ¨æ™‚é–“è¡çª
function checkTimeConflict(table, newReservationTime) {
    const tableState = tableStatus[table];
    
    // å¦‚æœæ¡Œå­æ˜¯ç©ºçš„ï¼Œæ²’æœ‰è¡çª
    if (!tableState || tableState.status !== "reserved") {
        return false;
    }
    
    // å¦‚æœå·²ç¶“æœ‰æ¬¡è¦é è¨‚ï¼Œä¸€å¾‹è¦–ç‚ºè¡çªï¼ˆä¸å…è¨±ç¬¬ä¸‰å€‹é è¨‚ï¼‰
    if (tableState.secondaryReservationId) {
        return true;
    }
    
    // æª¢æŸ¥èˆ‡ä¸»è¦é è¨‚çš„æ™‚é–“å·®
    const canDouble = canDoubleBook(tableState.reservedTime, newReservationTime);
    
    // å¦‚æœä¸èƒ½é›™é‡é è¨‚ï¼Œè¡¨ç¤ºæœ‰è¡çª
    return !canDouble;
}

        // æª¢æŸ¥æ¡Œå­æ˜¯å¦å¯ä»¥åˆ†é…çµ¦æ–°çš„é è¨‚
        function checkTableAvailability(table, newReservationTime) {
            // å¦‚æœæ¡Œå­æ˜¯ç©ºçš„ï¼Œå¯ä»¥é è¨‚
            if (!tableStatus[table]) return false;
            
            // å¦‚æœæ¡Œå­å·²ç¶“æœ‰ä¸€å€‹é è¨‚
            if (tableStatus[table].status === "reserved") {
                // å¦‚æœå·²ç¶“æœ‰æ¬¡è¦é è¨‚ï¼Œä¸å¯å†é è¨‚
                if (tableStatus[table].secondaryReservationId) return true;
                
                // æª¢æŸ¥èˆ‡ç¾æœ‰é è¨‚çš„æ™‚é–“é–“éš”æ˜¯å¦å…è¨±é›™é‡é è¨‚
                return !canDoubleBook(tableStatus[table].reservedTime, newReservationTime);
            }
            
            return false;
        }

        function assignTable(reservationId, table, reservedTime, index) {
    const tableState = tableStatus[table];
    
    // å¦‚æœæ¡Œå­æ˜¯ç©ºçš„æˆ–éé è¨‚ç‹€æ…‹
    if (!tableState || tableState.status !== "reserved") {
        tableStatus[table] = {
            status: "reserved",
            reservationId: reservationId,
            reservedTime: reservedTime
        };
    } 
    // å¦‚æœæ¡Œå­å·²ç¶“æœ‰ä¸€å€‹é è¨‚ä½†æ²’æœ‰æ¬¡è¦é è¨‚
    else if (!tableState.secondaryReservationId) {
        // æª¢æŸ¥æ™‚é–“æ˜¯å¦ç¬¦åˆé›™é‡é è¨‚çš„æ¢ä»¶
        if (canDoubleBook(tableState.reservedTime, reservedTime)) {
            tableStatus[table].secondaryReservationId = reservationId;
            tableStatus[table].secondaryReservedTime = reservedTime;
        }
    }
    
    reservedList[index].assignedTable = table;
    markDataChanged();
    renderTables();
    renderReservedList();
}
        function assignWaitingTable(table, index) {
            waitingList[index].assignedTable = table;
            markDataChanged();
            renderWaitingList();
        }

        function confirmSeating(table, index) {
    const reservation = reservedList[index];
    const tableState = tableStatus[table];
    
    
    
    // å¦‚æœæ˜¯ä¸»è¦é è¨‚è¢«å…¥åº§
    if (tableState.reservationId === reservation.id) {
        // ä¿å­˜æ¬¡è¦é è¨‚è³‡è¨Šï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        tableStatus[table] = {
            status: "occupied",
            startTime: new Date(),
            secondaryReservationId: tableState.secondaryReservationId,
            secondaryReservedTime: tableState.secondaryReservedTime
        };
    } 
    // å¦‚æœæ˜¯æ¬¡è¦é è¨‚è¢«å…¥åº§ï¼ˆé€™ç¨®æƒ…æ³æ‡‰è©²åœ¨ä¸Šé¢çš„æª¢æŸ¥ä¸­è¢«æ•ç²ï¼Œä½†ä»ä¿ç•™ä»£ç¢¼ä»¥é˜²è¬ä¸€ï¼‰
    else if (tableState.secondaryReservationId === reservation.id) {
        alert("è«‹åˆ‡æ›ç‚ºè¼ƒæ—©çš„é è¨‚ã€‚");
        return;
    }
    
    // å¾åˆ—è¡¨ä¸­ç§»é™¤å·²å…¥åº§çš„é è¨‚
    reservedList.splice(index, 1);
    markDataChanged();
    renderTables();
    renderReservedList();
}

    function confirmWaitingSeating(table, index) {
            tableStatus[table] = {
                status: "occupied",
                startTime: new Date()
            };
            waitingList.splice(index, 1);
            markDataChanged(); // æ¨™è¨˜æ•¸æ“šå·²è®ŠåŒ–
            renderTables();
            renderWaitingList();
        }

function cancelReservedOrder(index) {
    const canceledReservation = reservedList[index];
    const table = canceledReservation.assignedTable;
    
    if (table) {
        const tableState = tableStatus[table];
        
        // å¦‚æœæ˜¯ä¸»è¦è¨‚ä½å–æ¶ˆ
        if (tableState.reservationId === canceledReservation.id) {
            // å¦‚æœæœ‰æ¬¡è¦è¨‚ä½ï¼Œå°‡å…¶æå‡ç‚ºä¸»è¦è¨‚ä½
            if (tableState.secondaryReservationId) {
                tableStatus[table] = {
                    status: "reserved",
                    reservationId: tableState.secondaryReservationId,
                    reservedTime: tableState.secondaryReservedTime
                };
            } else {
                // å¦‚æœæ²’æœ‰æ¬¡è¦è¨‚ä½ï¼Œæ¸…ç©ºæ¡Œå­
                delete tableStatus[table];
            }
        } 
        // å¦‚æœæ˜¯æ¬¡è¦è¨‚ä½å–æ¶ˆ
        else if (tableState.secondaryReservationId === canceledReservation.id) {
            // æ¸…é™¤æ¬¡è¦è¨‚ä½
            delete tableState.secondaryReservationId;
            delete tableState.secondaryReservedTime;
        }
    }
    
    // å¾è¨‚ä½åˆ—è¡¨ä¸­ç§»é™¤è©²ç­†è¨‚ä½
    reservedList.splice(index, 1);
    markDataChanged();
    renderTables();
    renderReservedList();
}



        function cancelWaitingOrder(index) {
            const canceledWaiting = waitingList[index];
            if (canceledWaiting.assignedTable) {
                delete tableStatus[canceledWaiting.assignedTable];
            }
            waitingList.splice(index, 1);
            markDataChanged();
            renderWaitingList();
            renderTables();
        }

        function clearReservedInputs() {
            document.getElementById("reservedCount").value = "";
            document.getElementById("reservedName").value = "";
            document.getElementById("reservedPhone").value = "";
            document.getElementById("reservedTime").value = "11:00";
        }

        function clearWaitingInputs() {
            document.getElementById("waitingCount").value = "";
            document.getElementById("waitingName").value = "";
            document.getElementById("waitingPhone").value = "";
        }

         // åˆå§‹åŒ–é é¢
        window.onload = function() {
            document.getElementById("mrButtonReserved").classList.add("active");
            document.getElementById("mrButtonWaiting").classList.add("active");

            setupFirebaseListeners();
            renderTables();
            renderReservedList();
            renderWaitingList();

            dataChanged = false;
        };

        // åˆå§‹åŒ– Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // æ¸…é™¤ Firebase è³‡æ–™çš„å‡½æ•¸
        function clearFirebaseData() {
            if (confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼")) {
                database.ref().remove()
                    .then(() => {
                        console.log("Firebase è³‡æ–™å·²åˆªé™¤");
                        alert("è³‡æ–™å·²æ¸…é™¤ï¼");
                    })
                    .catch((error) => {
                        console.error("åˆªé™¤è³‡æ–™å¤±æ•—:", error);
                        alert("åˆªé™¤å¤±æ•—ï¼š" + error.message);
                    });
            }
        }
    </script>
</body>
</html>
