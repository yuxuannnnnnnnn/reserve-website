<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>餐廳桌位管理</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-database-compat.js"></script>
    <style>
        h1 {
            font-size: 0px; /* 調整 h1 的字體大小 */
        }
        h2 {
            font-size: 0px; /* 調整 h2 的字體大小 */
        }
        h3 {
            font-size: 0px; /* 調整 h3 的字體大小 */
        }
        /* 預設樣式（直式） */
body {
    font-family: Arial, sans-serif;
    text-align: center;
    margin: 20px;
    padding: 0;
}

.table-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    margin-top: 0px;
}

.table {
    width: 90px;
    height: 90px;
    margin: 5px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    position: relative;
    padding: 5px;
}

.tabs {
    display: flex;
    justify-content: center;
    margin: 20px 0px;
    width: 100%;
    max-width: 500px;
    margin-left: auto;
    margin-right: auto;
}

/* 橫式布局（螢幕寬度大於 700px） */
@media screen and (min-width: 700px) {
    body {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 20px;
    }

    .table-container {
        flex: 1;
        max-width: 50%;
        margin-right: 20px;
    }

    .reservation-container {
        flex: 1;
        max-width: 50%;
    }
}
        .reservation-id {
            position: absolute;
            top: 5px;
            left: 5px;
            font-size: 12px;
            color: #825400;
        }
        .reservation-id-secondary {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 12px;
            color: #825400;
            opacity: 0.6;
        }
        .empty { background-color: #ccc; }
        .reserved { background-color: #EFB700; }
        .occupied { background-color: #04AA6D; color: black; }
        .finished { background-color: #d9534f; color: white; }
        .finished::after { content: "收桌中"; font-size: 14px; }

        .input-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }
        input, button, select {
            padding: 10px;
            font-size: 14px;
        }
        .row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .name-buttons {
            display: flex;
            gap: 5px;
            margin: 0; /* 移除 margin-top，讓它和輸入框同一行 */
        }

        .name-buttons button {
            padding: 5px 10px;
            background-color: #ddd;
            border: none;
            cursor: pointer;
            border-radius: 2px;
        }

        .name-buttons button.active {
            background-color: #000000;
            color: white;
        }

        .waitlist-item {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 10px;
            width: 100%;
            max-width: 500px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #F7F7F7;
            text-align: center;
            box-sizing: border-box;
        }
        .button-container {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
        }
        .table-button {
            padding: 5px 10px;
            background-color: #04AA6D;
            color: white;
            border: none;
            cursor: pointer;
            
            border-radius: 2px;
        }
        .confirm-button {
            padding: 5px 10px;
            background-color: #000000;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 2px;
        }
        .cancel-button {
            padding: 5px 10px;
            background-color: #d9534f;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 2px;
        }
        .time-info {
            font-size: 14px;
            margin-top: 5px;
        }
        .before-time {
            color: #4286BD;
        }
        .after-time {
            color: #e51f1a;
        }
        ul {
            list-style: none;
            padding: 0;
            margin: 0;
            width: 100%;
        }
        /* 父級容器樣式 */
        .waitlist-container {
            display: flex;
            justify-content: center;
            align-items: center;     /* 垂直置中 */
            width: 100%;            /* 佔滿父元素寬度 */
            margin: 10px 0;         /* 上下留一些間距 */
        }

        /* 新增的 Tab 样式 */
        .tabs {
            display: flex;
            justify-content: center;
            margin: 20px 0px;
            width: 100%;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }
        .tab-button {
            flex: 1;
            padding: 6px;
            cursor: pointer;
            border: 1px solid #ccc;
            background-color: #f8f8f8;
            font-size: 18px;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .tab-button.active {
            background-color: #000000;
            color: white;
            border-color: #000000;
        }
        .tab-button:first-child {
            border-radius: 8px 0 0 8px;
        }
        .tab-button:last-child {
            border-radius: 0 8px 8px 0;
        }
        .tab-content {
            display: none;
            width: 100%;
        }
        .tab-content.active {
            display: block;
            
        }
        .table-button:disabled {
            background-color: #cccccc !important;
            cursor: not-allowed !important;
            opacity: 0.6;
        }
        /* 添加同步提示的樣式 */
        .sync-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
            transition: opacity 0.3s;
        }
        .syncing {
            background-color: #ffc107;
            color: #000;
        }
        .synced {
            background-color: #28a745;
            color: #fff;
        }
        .sync-error {
            background-color: #dc3545;
            color: #fff;
        }
        
    </style>
</head>
<body>
    <h1>餐廳桌位管理</h1>
    <!-- 同步狀態提示 -->
    <div id="syncStatus" class="sync-status" style="display: none;"></div>

    <!-- 桌位區 -->
    <div class="table-container" id="tables"></div>

    <!-- 訂位和候位區 -->
    <div class="reservation-container">
        <!-- Tab 切換按鈕 -->
        <div class="tabs">
            <div class="tab-button active" onclick="openTab('reservedTab')">訂位</div>
            <div class="tab-button" onclick="openTab('waitingTab')">候位</div>
        </div>

        <!-- 訂位 Tab 內容 -->
        <div id="reservedTab" class="tab-content active">
            <h2>已訂位</h2>
            <ul id="reservedList"></ul>
            <div class="input-container">
                <div class="row">
                    <input type="number" id="reservedCount" placeholder="人數" min="1">
                </div>
                <div class="row">
                    <input type="text" id="reservedName" placeholder="姓氏" style="width: 82px;">
                    <div class="name-buttons">
                        <button id="mrButtonReserved" onclick="selectTitleReserved('先生')">先生</button>
                        <button id="msButtonReserved" onclick="selectTitleReserved('小姐')">小姐</button>
                    </div>
                </div>
                <input type="tel" id="reservedPhone" placeholder="手機">
                <select id="reservedTime">
                    <option value="11:00">11:00</option>
                    <option value="11:30">11:30</option>
                    <option value="12:00">12:00</option>
                    <option value="12:30">12:30</option>
                    <option value="13:00">13:00</option>
                    <option value="17:00">17:00</option>
                    <option value="17:30">17:30</option>
                    <option value="18:00">18:00</option>
                    <option value="18:30">18:30</option>
                    <option value="19:00">19:00</option>
                    <option value="19:30">19:30</option>
                    <option value="20:00">20:00</option>
                </select>
                <button onclick="addToReservedList()">新增訂位</button>
            </div>
        </div>

        <!-- 候位 Tab 內容 -->
        <div id="waitingTab" class="tab-content">
            <h3>已候位</h3>
            <ul id="waitingList"></ul>
            <div class="input-container">
                <div class="row">
                    <input type="number" id="waitingCount" placeholder="人數" min="1">
                </div>
                <div class="row">
                    <input type="text" id="waitingName" placeholder="姓氏" style="width: 82px;">
                    <div class="name-buttons">
                        <button id="mrButtonWaiting" onclick="selectTitleWaiting('先生')">先生</button>
                        <button id="msButtonWaiting" onclick="selectTitleWaiting('小姐')">小姐</button>
                    </div>
                </div>
                <input type="tel" id="waitingPhone" placeholder="手機">
                <button onclick="addToWaitingList()">新增候位</button>
            </div>
        </div>
    </div>


    <script>
        // Firebase 配置
        const firebaseConfig = {
            apiKey: "AIzaSyCp8_-QPKaR6Q6ECK9np3OPqW6dO967wpk",
            authDomain: "reserve-a3e41.firebaseapp.com",
            databaseURL: "https://reserve-a3e41-default-rtdb.firebaseio.com",
            projectId: "reserve-a3e41",
            storageBucket: "reserve-a3e41.firebasestorage.app",
            messagingSenderId: "25864343238",
            appId: "1:25864343238:web:7d31cb753ae557b49391c7",
            measurementId: "G-EX5CQE079X"
        };
        
        // 初始化 Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // 同步狀態顯示函數
        function showSyncStatus(status, message) {
            const syncStatus = document.getElementById('syncStatus');
            syncStatus.textContent = message;
            syncStatus.className = 'sync-status ' + status;
            syncStatus.style.display = 'block';
            
            // 3秒後隱藏提示（除非是同步中狀態）
            if (status !== 'syncing') {
                setTimeout(() => {
                    syncStatus.style.opacity = '0';
                    setTimeout(() => {
                        syncStatus.style.display = 'none';
                        syncStatus.style.opacity = '1';
                    }, 300);
                }, 3000);
            }
        }
        
        const tables = [1, 2, 4, 5, 6, 7, 8, 10];
        let tableStatus = {};
        let reservedList = [];
        let waitingList = [];
        let reservationCounter = 1;
        let waitingCounter = 1;
        let selectedTitleReserved = "先生";
        let selectedTitleWaiting = "先生";
        let dataChanged = false; // 用於追踪數據是否有變化
        let isSyncing = false; // 避免同步衝突

        // 修改后的 Firebase 监听器设置函数
    function setupFirebaseListeners() {
    // 監聽連接狀態
    const connectedRef = database.ref('.info/connected');
    connectedRef.on('value', (snap) => {
        if (snap.val() === true) {
            console.log('已連接到 Firebase');
            showSyncStatus('synced', '已連接到伺服器');
            
            // 如果有未同步的數據，立即同步
            if (dataChanged) {
                syncToFirebase();
            }
        } else {
            console.log('未連接到 Firebase');
            showSyncStatus('sync-error', '伺服器連接斷開');
        }
    });
    
    // 設置監聽器的方法，包含重試邏輯
    function setupListener(path, callback, errorHandler) {
        let retryCount = 0;
        const MAX_RETRIES = 5;
        
        function attemptListen() {
            database.ref(path).on('value', callback, (error) => {
                console.error(`${path} 監聽錯誤:`, error);
                if (errorHandler) errorHandler(error);
                
                // 如果錯誤是暫時性的，嘗試重新監聽
                if (retryCount < MAX_RETRIES) {
                    retryCount++;
                    const delay = Math.min(1000 * Math.pow(2, retryCount), 30000);
                    console.log(`嘗試重新監聽 ${path}，${retryCount}/${MAX_RETRIES}，等待 ${delay}ms`);
                    
                    setTimeout(() => {
                        attemptListen();
                    }, delay);
                } else {
                    showSyncStatus('sync-error', `監聽 ${path} 失敗，請重新整理頁面`);
                }
            });
        }
        
        attemptListen();
    }
    
    // 使用改進的監聽器設置方法 - 桌位狀態
    setupListener('tableStatus', (snapshot) => {
        if (!isSyncing) {
            const data = snapshot.val();
            if (data) {
                // 轉換 Firebase 數據格式（處理 timestamp）
                tableStatus = {};
                Object.keys(data).forEach(table => {
                    tableStatus[table] = convertFromFirebase(data[table]);
                });
                renderTables();
                showSyncStatus('synced', '已同步桌位狀態');
            }
        }
    }, (error) => {
        showSyncStatus('sync-error', '同步錯誤：桌位狀態');
    });
    
    // 監聽訂位列表
    setupListener('reservedList', (snapshot) => {
        if (!isSyncing) {
            const data = snapshot.val();
            if (data) {
                reservedList = [];
                // 將 Firebase 物件轉換為數組
                Object.values(data).forEach(item => {
                    reservedList.push(item);
                });
                // 更新計數器，找到最大的 ID 並加 1
                if (reservedList.length > 0) {
                    reservationCounter = Math.max(...reservedList.map(item => item.id)) + 1;
                }
                renderReservedList();
                showSyncStatus('synced', '已同步訂位清單');
            }
        }
    }, (error) => {
        showSyncStatus('sync-error', '同步錯誤：訂位清單');
    });
    
    // 監聽候位列表
    setupListener('waitingList', (snapshot) => {
        if (!isSyncing) {
            const data = snapshot.val();
            if (data) {
                waitingList = [];
                // 將 Firebase 物件轉換為數組
                Object.values(data).forEach(item => {
                    waitingList.push(item);
                });
                // 更新計數器，找到最大的 ID 並加 1
                if (waitingList.length > 0) {
                    waitingCounter = Math.max(...waitingList.map(item => item.id)) + 1;
                }
                renderWaitingList();
                showSyncStatus('synced', '已同步候位清單');
            }
        }
    }, (error) => {
        showSyncStatus('sync-error', '同步錯誤：候位清單');
    });
    
    // 監聽計數器（用於確保 ID 不重複）
    setupListener('counters', (snapshot) => {
        if (!isSyncing) {
            const data = snapshot.val();
            if (data) {
                if (data.reservation && data.reservation > reservationCounter) {
                    reservationCounter = data.reservation;
                }
                if (data.waiting && data.waiting > waitingCounter) {
                    waitingCounter = data.waiting;
                }
                showSyncStatus('synced', '已同步計數器');
            }
        }
    }, (error) => {
        showSyncStatus('sync-error', '同步錯誤：計數器');
    });
}
        
        // 將對象轉換為Firebase可存儲的格式（處理Date對象）
        function convertToFirebase(obj) {
            if (!obj) return obj;
            
            const result = {};
            Object.keys(obj).forEach(key => {
                if (obj[key] instanceof Date) {
                    // 將Date轉換為timestamp
                    result[key] = {
                        __isDate: true,
                        timestamp: obj[key].getTime()
                    };
                } else if (typeof obj[key] === 'object' && obj[key] !== null) {
                    result[key] = convertToFirebase(obj[key]);
                } else {
                    result[key] = obj[key];
                }
            });
            return result;
        }
        
        // 將Firebase數據轉換回原始格式
        function convertFromFirebase(obj) {
            if (!obj) return obj;
            
            const result = {};
            Object.keys(obj).forEach(key => {
                if (obj[key] && obj[key].__isDate && obj[key].timestamp) {
                    // 將timestamp轉回Date對象
                    result[key] = new Date(obj[key].timestamp);
                } else if (typeof obj[key] === 'object' && obj[key] !== null) {
                    result[key] = convertFromFirebase(obj[key]);
                } else {
                    result[key] = obj[key];
                }
            });
            return result;
        }
        
        // 添加防抖变量
let syncDebounceTimer = null;

// 修改后的 markDataChanged 函数
function markDataChanged() {
    dataChanged = true;
    
    // 清除之前的定时器
    if (syncDebounceTimer) {
        clearTimeout(syncDebounceTimer);
    }
    
    // 设置新的定时器，延迟 500ms 同步数据
    syncDebounceTimer = setTimeout(() => {
        syncToFirebase();
    }, 500);
}

// 修改后的 syncToFirebase 函数，添加更多错误处理和状态反馈
function syncToFirebase() {
    if (isSyncing) return;
    
    isSyncing = true;
    showSyncStatus('syncing', '資料同步中...');
    
    try {
        // 轉換數據格式
        const fbTableStatus = {};
        Object.keys(tableStatus).forEach(table => {
            fbTableStatus[table] = convertToFirebase(tableStatus[table]);
        });
        
        // 創建一個批量更新物件
        const updates = {};
        updates['tableStatus'] = fbTableStatus;
        
        // 儲存訂位清單
        updates['reservedList'] = reservedList.reduce((acc, item, index) => {
            acc[index] = item;
            return acc;
        }, {});
        
        // 儲存候位清單
        updates['waitingList'] = waitingList.reduce((acc, item, index) => {
            acc[index] = item;
            return acc;
        }, {});
        
        // 儲存計數器
        updates['counters'] = {
            reservation: reservationCounter,
            waiting: waitingCounter
        };
        
        // 批量更新 Firebase
        database.ref().update(updates)
            .then(() => {
                isSyncing = false;
                dataChanged = false;
                showSyncStatus('synced', '資料已同步');
                console.log("同步成功，時間：", new Date().toLocaleTimeString());
            })
            .catch(error => {
                console.error("Firebase同步錯誤:", error);
                isSyncing = false;
                showSyncStatus('sync-error', '同步失敗：' + error.message);
                
                // 在同步失敗後，過一段時間自動重試
                setTimeout(() => {
                    if (dataChanged) {
                        console.log("嘗試重新同步...");
                        syncToFirebase();
                    }
                }, 3000);
            });
    } catch (e) {
        console.error("同步數據處理錯誤:", e);
        isSyncing = false;
        showSyncStatus('sync-error', '處理數據錯誤：' + e.message);
    }
}
        // 3. 改進客戶端儲存機制，使用 localStorage 作為備份
// 以防 Firebase 同步失敗時有臨時備份

function backupToLocalStorage() {
    try {
        localStorage.setItem('tableStatus', JSON.stringify(tableStatus));
        localStorage.setItem('reservedList', JSON.stringify(reservedList));
        localStorage.setItem('waitingList', JSON.stringify(waitingList));
        localStorage.setItem('reservationCounter', reservationCounter);
        localStorage.setItem('waitingCounter', waitingCounter);
        localStorage.setItem('backupTime', new Date().toISOString());
        console.log('已備份到本地儲存');
    } catch (e) {
        console.error('備份到本地儲存失敗:', e);
    }
}

function restoreFromLocalStorage() {
    try {
        const backupTime = localStorage.getItem('backupTime');
        if (!backupTime) return false;
        
        // 確認備份不超過24小時
        const backupDate = new Date(backupTime);
        const now = new Date();
        const hoursDiff = (now - backupDate) / (1000 * 60 * 60);
        
        if (hoursDiff > 24) {
            console.log('本地備份過期');
            return false;
        }
        
        // 從 localStorage 恢復數據
        const localTableStatus = JSON.parse(localStorage.getItem('tableStatus') || '{}');
        const localReservedList = JSON.parse(localStorage.getItem('reservedList') || '[]');
        const localWaitingList = JSON.parse(localStorage.getItem('waitingList') || '[]');
        const localReservationCounter = parseInt(localStorage.getItem('reservationCounter') || '1');
        const localWaitingCounter = parseInt(localStorage.getItem('waitingCounter') || '1');
        
        // 應用數據
        tableStatus = localTableStatus;
        reservedList = localReservedList;
        waitingList = localWaitingList;
        reservationCounter = localReservationCounter;
        waitingCounter = localWaitingCounter;
        
        console.log('已從本地備份恢復數據');
        return true;
    } catch (e) {
        console.error('從本地備份恢復失敗:', e);
        return false;
    }
}

        

        // 修改 markDataChanged 函數
function markDataChanged() {
    dataChanged = true;
    
    // 清除之前的定時器
    if (syncDebounceTimer) {
        clearTimeout(syncDebounceTimer);
    }
    
    // 先進行本地備份
    backupToLocalStorage();
    
    // 設置新的定時器，延遲 500ms 同步數據
    syncDebounceTimer = setTimeout(() => {
        syncToFirebase();
    }, 500);
}
        // 5. 修改頁面初始化函數，確保在 Firebase 連接失敗時嘗試從本地恢復

window.onload = function() {
    document.getElementById("mrButtonReserved").classList.add("active");
    document.getElementById("mrButtonWaiting").classList.add("active");
    
    // 先從 Firebase 載入數據
    setupFirebaseListeners();
    
    // 如果 Firebase 連接失敗或數據為空，嘗試從本地恢復
    setTimeout(() => {
        if (reservedList.length === 0 && waitingList.length === 0) {
            if (restoreFromLocalStorage()) {
                renderTables();
                renderReservedList();
                renderWaitingList();
                markDataChanged(); // 確保恢復的數據會同步回 Firebase
            }
        }
    }, 2000); // 給 Firebase 2秒時間載入數據
    
    renderTables();
    renderReservedList();
    renderWaitingList();
    
    dataChanged = false;
};

// 6. 新增一個自動儲存功能，定期將數據備份到 localStorage
setInterval(() => {
    backupToLocalStorage();
}, 30000); // 每30秒備份一次


        // Tab 切換功能
        function openTab(tabName) {
            const tabContents = document.getElementsByClassName("tab-content");
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove("active");
            }

            const tabButtons = document.getElementsByClassName("tab-button");
            for (let i = 0; i < tabButtons.length; i++) {
                tabButtons[i].classList.remove("active");
            }

            document.getElementById(tabName).classList.add("active");
            
            // 找到相應的按鈕並激活它
            const buttons = document.getElementsByClassName("tab-button");
            for (let i = 0; i < buttons.length; i++) {
                if (buttons[i].getAttribute("onclick").includes(tabName)) {
                    buttons[i].classList.add("active");
                }
            }
        }

        function renderTables() {
            const container = document.getElementById("tables");
            container.innerHTML = "";

            tables.forEach(table => {
                const status = tableStatus[table]?.status || "empty";
                const tableDiv = document.createElement("div");
                tableDiv.className = `table ${status}`;
                
                // 主要訂位ID
                if (tableStatus[table]?.reservationId) {
                    const reservationId = document.createElement("div");
                    reservationId.className = "reservation-id";
                    reservationId.textContent = `訂${tableStatus[table].reservationId}`;
                    tableDiv.appendChild(reservationId);
                }
                
                // 次要訂位ID
                if (tableStatus[table]?.secondaryReservationId) {
                    const secondaryReservationId = document.createElement("div");
                    secondaryReservationId.className = "reservation-id-secondary";
                    secondaryReservationId.textContent = `訂${tableStatus[table].secondaryReservationId}`;
                    tableDiv.appendChild(secondaryReservationId);
                }

                const tableNumber = document.createElement("div");
                tableNumber.textContent = `A${table}`;
                tableDiv.appendChild(tableNumber);

                // 如果是已入座狀態
                if (status === "occupied" && tableStatus[table].startTime) {
                    const startTime = tableStatus[table].startTime;
                    const endTime = new Date(startTime.getTime() + 90 * 60000);
                    const timeInfo = document.createElement("div");
                    timeInfo.className = "time-info";
                    timeInfo.innerHTML = 
                        `<div style="color: #005435;">${formatTime(startTime)} 入座<br>
                        <div style="color: #FFFFFF;">${formatTime(endTime)} 結束`
                    ;
                    tableDiv.appendChild(timeInfo);
                }

                // 如果是訂位狀態，顯示當前活動的預訂信息
                if (status === "reserved" && tableStatus[table]?.reservedTime) {
                    const timeInfo = document.createElement("div");
                    timeInfo.className = "time-info";
                    
                    const reservedTime = tableStatus[table].reservedTime;
                    const beforeTime = getTimeBeforeReservation(reservedTime);
                    const afterTime = getTimeAfterReservation(reservedTime);
                    
                    timeInfo.innerHTML = 
                        `<div class="before-time">${beforeTime} 前可接</div>
                        <div>${reservedTime}</div>
                        <div class="after-time">${afterTime} 後可接</div>`
                    ;
                    tableDiv.appendChild(timeInfo);
                }

                // 修改點擊事件處理邏輯
                tableDiv.onclick = () => toggleTable(table);
                container.appendChild(tableDiv);
            });
        }

        function toggleTable(table) {
            const tableState = tableStatus[table];
            
            // If empty table, set to occupied
            if (!tableState || tableState.status === "empty") {
                tableStatus[table] = { 
                    status: "occupied", 
                    startTime: new Date() 
                };
                markDataChanged();
                renderTables();
                return;
            }
            
            // If table has a reservation and no secondary reservation, do nothing
            if (tableState?.status === "reserved" && !tableState?.secondaryReservationId) {
                return;
            }
            
            // If table has both primary and secondary reservations, swap them
            if (tableState?.status === "reserved" && tableState?.secondaryReservationId) {
                const tempId = tableState.reservationId;
                const tempTime = tableState.reservedTime;
                
                tableStatus[table].reservationId = tableState.secondaryReservationId;
                tableStatus[table].reservedTime = tableState.secondaryReservedTime;
                
                tableStatus[table].secondaryReservationId = tempId;
                tableStatus[table].secondaryReservedTime = tempTime;
                
                markDataChanged();
                renderTables();
                return;
            }
            
            // If table is occupied and has a secondary reservation
            if (tableState?.status === "occupied" && tableState?.secondaryReservationId) {
                tableStatus[table] = { 
                    status: "finished", 
                    secondaryReservationId: tableState.secondaryReservationId,
                    secondaryReservedTime: tableState.secondaryReservedTime
                };
                markDataChanged();
                renderTables();
                return;
            }
            
            // If table is in "finished" state and has a secondary reservation
            if (tableState?.status === "finished" && tableState?.secondaryReservationId) {
                tableStatus[table] = { 
                    status: "reserved", 
                    reservationId: tableState.secondaryReservationId,
                    reservedTime: tableState.secondaryReservedTime,
                    secondaryReservationId: null,
                    secondaryReservedTime: null
                };
                markDataChanged();
                renderTables();
                return;
            }
            
            // Standard state transitions for tables without secondary reservations
            if (tableState.status === "occupied") {
                tableStatus[table] = { status: "finished" };
            } else if (tableState.status === "finished") {
                tableStatus[table] = { status: "empty" };
            }
            
            markDataChanged();
            renderTables();
            renderReservedList();
            renderWaitingList();
        }

        function formatTime(date) {
            return date.toLocaleTimeString("zh-TW", { 
                hour: "2-digit", 
                minute: "2-digit", 
                hour12: false 
            });
        }

        function getTimeBeforeReservation(time) {
            const [hours, minutes] = time.split(':').map(Number);
            const date = new Date();
            date.setHours(hours);
            date.setMinutes(minutes - 90);
            return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        }

        function getTimeAfterReservation(time) {
            const [hours, minutes] = time.split(':').map(Number);
            const date = new Date();
            date.setHours(hours);
            date.setMinutes(minutes + 90);
            return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        }

        // 檢查兩個預訂時間是否可以共存
        function canDoubleBook(time1, time2) {
            const [hours1, minutes1] = time1.split(':').map(Number);
            const [hours2, minutes2] = time2.split(':').map(Number);
            
            // 計算兩個時間點之間的分鐘差
            const time1Minutes = hours1 * 60 + minutes1;
            const time2Minutes = hours2 * 60 + minutes2;
            
            // 計算時間差的絕對值
            const timeDiff = Math.abs(time1Minutes - time2Minutes);
            
            // 如果時間差大於等於90分鐘，則允許雙重預訂
            return timeDiff >= 90;
        }

        function selectTitleReserved(title) {
            selectedTitleReserved = title;
            document.getElementById("mrButtonReserved").classList.toggle("active", title === "先生");
            document.getElementById("msButtonReserved").classList.toggle("active", title === "小姐");
        }

        function selectTitleWaiting(title) {
            selectedTitleWaiting = title;
            document.getElementById("mrButtonWaiting").classList.toggle("active", title === "先生");
            document.getElementById("msButtonWaiting").classList.toggle("active", title === "小姐");
        }

        function addToReservedList() {
            const count = document.getElementById("reservedCount").value;
            const name = document.getElementById("reservedName").value;
            const phone = document.getElementById("reservedPhone").value;
            const reservedTime = document.getElementById("reservedTime").value;
            
            if (!count || !name || !phone || !reservedTime) return;
            
            const reservation = {
                id: reservationCounter++,
                count,
                name,
                title: selectedTitleReserved,
                phone,
                reservedTime,
                assignedTable: null
            };
            
            reservedList.push(reservation);
            markDataChanged();
            clearReservedInputs();
            renderReservedList();
        }

        function addToWaitingList() {
            const count = document.getElementById("waitingCount").value;
            const name = document.getElementById("waitingName").value;
            const phone = document.getElementById("waitingPhone").value;
            
            if (!count || !name || !phone) return;
            
            const waiting = {
                id: waitingCounter++,
                count,
                name,
                title: selectedTitleWaiting,
                phone,
                assignedTable: null
            };
            
            waitingList.push(waiting);
            markDataChanged();
            clearWaitingInputs();
            renderWaitingList();
        }

        // 修改渲染預訂列表的函數，增加桌子按鈕禁用邏輯
function renderReservedList() {
    const list = document.getElementById("reservedList");
    list.innerHTML = "";
    
    reservedList.forEach((guest, index) => {
        // 創建父容器
        const container = document.createElement("div");
        container.className = "waitlist-container";
        
        const li = document.createElement("li");
        li.className = "waitlist-item";
        li.innerHTML = `訂${guest.id} - ${guest.count}位 - ${guest.title} ${guest.name} - ${guest.phone} - 訂位時間 ${guest.reservedTime}`;
        
        const buttonContainer = document.createElement("div");
        buttonContainer.className = "button-container";

        if (!guest.assignedTable) {
            tables.forEach(table => {
                const button = document.createElement("button");
                button.className = "table-button";
                button.textContent = `A${table}`;
                
                // 檢查該桌是否有衝突的預訂時間
                const isConflict = checkTimeConflict(table, guest.reservedTime);
                
                if (isConflict) {
                    // 如果時間衝突，禁用按鈕
                    button.disabled = true;
                    button.style.backgroundColor = "#cccccc";
                    button.style.cursor = "not-allowed";
                    button.title = "此桌已有時間相近的預訂";
                } else {
                    button.onclick = () => assignTable(guest.id, table, guest.reservedTime, index);
                }
                
                buttonContainer.appendChild(button);
            });
        } else {
            const confirmButton = document.createElement("button");
            confirmButton.className = "confirm-button";
            confirmButton.textContent = `確認入座 A${guest.assignedTable}`;
            confirmButton.onclick = () => confirmSeating(guest.assignedTable, index);
            buttonContainer.appendChild(confirmButton);
        }

        const cancelButton = document.createElement("button");
        cancelButton.className = "cancel-button";
        cancelButton.textContent = "取消訂位";
        cancelButton.onclick = () => cancelReservedOrder(index);
        buttonContainer.appendChild(cancelButton);

        li.appendChild(buttonContainer);
        container.appendChild(li); // 將 li 放入父級容器中
        list.appendChild(container);
    });
}

        function renderWaitingList() {
    const list = document.getElementById("waitingList");
    list.innerHTML = "";

    waitingList.forEach((guest, index) => {
        const container = document.createElement("div");
        container.className = "waitlist-container";

        const li = document.createElement("li");
        li.className = "waitlist-item";
        li.innerHTML = `候${guest.id} - ${guest.count}位 - ${guest.title} ${guest.name} - ${guest.phone}`;

        const buttonContainer = document.createElement("div");
        buttonContainer.className = "button-container";

        if (!guest.assignedTable) {
            tables.forEach(table => {
                const button = document.createElement("button");
                button.className = "table-button";
                button.textContent = `A${table}`;

                button.onclick = () => assignWaitingTable(table, index);
                buttonContainer.appendChild(button);
            });
        } else {
            li.innerHTML += ` - A${guest.assignedTable}`;
            const confirmButton = document.createElement("button");
            confirmButton.className = "confirm-button";
            confirmButton.textContent = "確認入座";
            confirmButton.onclick = () => confirmWaitingSeating(guest.assignedTable, index);
            buttonContainer.appendChild(confirmButton);
        }

        const cancelButton = document.createElement("button");
        cancelButton.className = "cancel-button";
        cancelButton.textContent = "取消候位";
        cancelButton.onclick = () => cancelWaitingOrder(index);
        buttonContainer.appendChild(cancelButton);

        li.appendChild(buttonContainer);
        container.appendChild(li);
        list.appendChild(container);
    });
}
// 新增函數：檢查是否存在時間衝突
function checkTimeConflict(table, newReservationTime) {
    const tableState = tableStatus[table];
    
    // 如果桌子是空的，沒有衝突
    if (!tableState || tableState.status !== "reserved") {
        return false;
    }
    
    // 如果已經有次要預訂，一律視為衝突（不允許第三個預訂）
    if (tableState.secondaryReservationId) {
        return true;
    }
    
    // 檢查與主要預訂的時間差
    const canDouble = canDoubleBook(tableState.reservedTime, newReservationTime);
    
    // 如果不能雙重預訂，表示有衝突
    return !canDouble;
}

        // 檢查桌子是否可以分配給新的預訂
        function checkTableAvailability(table, newReservationTime) {
            // 如果桌子是空的，可以預訂
            if (!tableStatus[table]) return false;
            
            // 如果桌子已經有一個預訂
            if (tableStatus[table].status === "reserved") {
                // 如果已經有次要預訂，不可再預訂
                if (tableStatus[table].secondaryReservationId) return true;
                
                // 檢查與現有預訂的時間間隔是否允許雙重預訂
                return !canDoubleBook(tableStatus[table].reservedTime, newReservationTime);
            }
            
            return false;
        }

        function assignTable(reservationId, table, reservedTime, index) {
    const tableState = tableStatus[table];
    
    // 如果桌子是空的或非預訂狀態
    if (!tableState || tableState.status !== "reserved") {
        tableStatus[table] = {
            status: "reserved",
            reservationId: reservationId,
            reservedTime: reservedTime
        };
    } 
    // 如果桌子已經有一個預訂但沒有次要預訂
    else if (!tableState.secondaryReservationId) {
        // 檢查時間是否符合雙重預訂的條件
        if (canDoubleBook(tableState.reservedTime, reservedTime)) {
            tableStatus[table].secondaryReservationId = reservationId;
            tableStatus[table].secondaryReservedTime = reservedTime;
        }
    }
    
    reservedList[index].assignedTable = table;
    markDataChanged();
    renderTables();
    renderReservedList();
}
        function confirmSeating(table, index) {
    console.log("confirmSeating 被调用:", { table, index });
    
    // 检查参数有效性
    if (table === undefined || table === null) {
        console.error("错误: 桌号为空");
        alert("错误: 无法确认入座，桌号不存在");
        return;
    }
    
    if (index === undefined || index < 0 || index >= reservedList.length) {
        console.error("错误: 无效的订位索引", index, "列表长度:", reservedList.length);
        alert("错误: 无法确认入座，订位记录不存在");
        return;
    }
    
    // 获取订位信息
    const reservation = reservedList[index];
    console.log("订位信息:", reservation);
    
    // 检查订位信息有效性
    if (!reservation) {
        console.error("错误: 订位信息不存在");
        alert("错误: 无法获取订位信息");
        return;
    }
    
    // 检查 table 是否在 tableStatus 中存在
    if (!tableStatus[table]) {
        console.log("桌子状态不存在，创建新状态");
        tableStatus[table] = {
            status: "occupied",
            startTime: new Date()
        };
    } else {
        console.log("当前桌子状态:", tableStatus[table]);
        
        // 安全地访问 reservationId
        const currentReservationId = tableStatus[table].reservationId;
        const secondaryReservationId = tableStatus[table].secondaryReservationId;
        
        console.log("比较ID:", {
            currentReservationId,
            secondaryReservationId,
            reservationId: reservation.id
        });
        
        // 如果是主要预订被入座
        if (currentReservationId === reservation.id) {
            console.log("确认主要预订入座");
            // 保存次要预订信息（如果存在）
            const newStatus = {
                status: "occupied",
                startTime: new Date()
            };
            
            // 如果存在次要预订，保留它
            if (secondaryReservationId) {
                newStatus.secondaryReservationId = secondaryReservationId;
                newStatus.secondaryReservedTime = tableStatus[table].secondaryReservedTime;
            }
            
            tableStatus[table] = newStatus;
        } 
        // 如果是次要预订被入座
        else if (secondaryReservationId === reservation.id) {
            console.log("尝试确认次要预订入座 - 需要先切换");
            alert("請先切換為此預訂，再確認入座");
            return;
        }
        // 如果桌子状态与预订不匹配
        else {
            console.log("预订ID与桌子不匹配，强制设置入座状态");
            tableStatus[table] = {
                status: "occupied",
                startTime: new Date()
            };
        }
    }
    
    try {
        // 从列表中移除已入座的预订
        console.log("移除预订，索引:", index);
        reservedList.splice(index, 1);
        
        // 确保数据标记为已更改并同步
        console.log("标记数据已更改");
        markDataChanged();
        
        console.log("重新渲染界面");
        renderTables();
        renderReservedList();
        
        console.log("入座操作完成");
    } catch (error) {
        console.error("处理预订时发生错误:", error);
        alert("处理预订时发生错误: " + error.message);
    }
}
    
    

    function confirmWaitingSeating(table, index) {
            tableStatus[table] = {
                status: "occupied",
                startTime: new Date()
            };
            waitingList.splice(index, 1);
            markDataChanged(); // 標記數據已變化
            renderTables();
            renderWaitingList();
        }

function cancelReservedOrder(index) {
    const canceledReservation = reservedList[index];
    const table = canceledReservation.assignedTable;
    
    if (table) {
        const tableState = tableStatus[table];
        
        // 如果是主要訂位取消
        if (tableState.reservationId === canceledReservation.id) {
            // 如果有次要訂位，將其提升為主要訂位
            if (tableState.secondaryReservationId) {
                tableStatus[table] = {
                    status: "reserved",
                    reservationId: tableState.secondaryReservationId,
                    reservedTime: tableState.secondaryReservedTime
                };
            } else {
                // 如果沒有次要訂位，清空桌子
                delete tableStatus[table];
            }
        } 
        // 如果是次要訂位取消
        else if (tableState.secondaryReservationId === canceledReservation.id) {
            // 清除次要訂位
            delete tableState.secondaryReservationId;
            delete tableState.secondaryReservedTime;
        }
    }
    
    // 從訂位列表中移除該筆訂位
    reservedList.splice(index, 1);
    markDataChanged();
    renderTables();
    renderReservedList();
}

       function assignWaitingTable(table, index) {
    // 檢查桌子是否可用
    

    // 設置候位記錄的 assignedTable
    waitingList[index].assignedTable = table;

    // 標記數據已變化並重新渲染
    markDataChanged();
    renderTables();
    renderWaitingList();
}


        function cancelWaitingOrder(index) {
            const canceledWaiting = waitingList[index];
            if (canceledWaiting.assignedTable) {
                delete tableStatus[canceledWaiting.assignedTable];
            }
            waitingList.splice(index, 1);
            markDataChanged();
            renderWaitingList();
            renderTables();
        }

        function clearReservedInputs() {
            document.getElementById("reservedCount").value = "";
            document.getElementById("reservedName").value = "";
            document.getElementById("reservedPhone").value = "";
            document.getElementById("reservedTime").value = "11:00";
        }

        function clearWaitingInputs() {
            document.getElementById("waitingCount").value = "";
            document.getElementById("waitingName").value = "";
            document.getElementById("waitingPhone").value = "";
        }

         // 初始化頁面
        window.onload = function() {
            document.getElementById("mrButtonReserved").classList.add("active");
            document.getElementById("mrButtonWaiting").classList.add("active");

            setupFirebaseListeners();
            renderTables();
            renderReservedList();
            renderWaitingList();

            dataChanged = false;
        };

        
    </script>
</body>
</html>
